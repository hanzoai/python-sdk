name: Quality Gate - STRICT NO BULLSHIT

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  release:
    types: [created]

# Cancel any in-progress runs when a new run starts
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  block-todo-stub-code:
    name: "ğŸš« Block TODO/STUB/FAKE Code"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ” Search for forbidden patterns in hanzo-mcp"
        run: |
          echo "Searching for problematic TODO/STUB patterns in hanzo-mcp..."

          # Focus on hanzo-mcp package only (other packages may have legitimate TODOs)
          # We look for specific problematic patterns, not all TODOs

          FOUND_ISSUES=0

          # Check for stub functions that return "TODO" or "STUB" strings
          echo "Checking for stub return values..."
          if grep -rn --include="*.py" -E "return\s+['\"]TODO['\"]|return\s+['\"]STUB['\"]" pkg/hanzo-mcp/hanzo_mcp/ 2>/dev/null; then
            echo "âŒ Found stub return values"
            FOUND_ISSUES=1
          fi

          # Check for empty pass-only functions (excluding fallback stubs in except blocks)
          echo "Checking for empty functions..."
          # This is better handled by the pytest test_no_stubs.py

          # Check for explicit "STUB:" or "FAKE:" comments indicating unfinished code
          echo "Checking for explicit stub markers..."
          if grep -rn --include="*.py" -E "#\s*(STUB|FAKE|UNFINISHED):" pkg/hanzo-mcp/hanzo_mcp/ 2>/dev/null; then
            echo "âŒ Found explicit stub markers"
            FOUND_ISSUES=1
          fi

          if [ $FOUND_ISSUES -eq 1 ]; then
            echo "ğŸš« DEPLOYMENT BLOCKED: Remove stub/fake code before deploying!"
            exit 1
          fi

          echo "âœ… No forbidden stub patterns found in hanzo-mcp"
          echo "Note: Other packages may contain legitimate TODO comments for documentation"

  test-no-stubs:
    name: "ğŸ§ª Anti-Stub Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install uv
          uv venv
          source .venv/bin/activate
          uv pip install -e ./pkg/hanzo-mcp[test]

      - name: "Run anti-stub tests"
        run: |
          source .venv/bin/activate
          cd pkg/hanzo-mcp
          python -m pytest tests/test_no_stubs.py -v --tb=short

      - name: "Verify no incomplete implementations"
        run: |
          source .venv/bin/activate
          cd pkg/hanzo-mcp
          # Run the test file directly for extra validation
          python tests/test_no_stubs.py

  all-tests-must-pass:
    name: "âœ… ALL Tests Must Pass"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true  # Stop immediately if any test fails
      matrix:
        python-version: ['3.12']

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install test dependencies
        run: |
          pip install uv
          uv venv
          source .venv/bin/activate
          # Install hanzo-mcp with test deps and optional memory/agents packages
          uv pip install -e ./pkg/hanzo-mcp[test,memory,agents]
          # Install sibling packages for integration tests
          uv pip install -e ./pkg/hanzo-memory || true
          uv pip install -e ./pkg/hanzo-network || true

      - name: "ğŸ§ª Run ALL tests"
        run: |
          source .venv/bin/activate
          cd pkg/hanzo-mcp
          # Run with strict mode
          python -m pytest tests/ \
            -v \
            --strict-markers \
            --tb=short \
            --maxfail=5 \
            --no-cov \
            2>&1 | tee test-output.log

          # Check if any tests failed
          if grep -q "FAILED" test-output.log; then
            echo "âŒ TESTS FAILED! All tests must pass!"
            exit 1
          fi

          # Note: Skips are allowed for optional dependency tests
          echo "âœ… All tests passed!"

  code-quality:
    name: "ğŸ¯ Code Quality Check"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install quality tools
        run: |
          pip install ruff mypy pyright bandit

      - name: "ğŸ” Lint with ruff"
        run: |
          cd pkg/hanzo-mcp
          ruff check . --fix --exit-non-zero-on-fix

      - name: "ğŸ” Type check with mypy"
        run: |
          cd pkg/hanzo-mcp
          mypy hanzo_mcp --ignore-missing-imports --strict || true

      - name: "ğŸ” Security scan with bandit"
        run: |
          cd pkg/hanzo-mcp
          bandit -r hanzo_mcp -f json -o bandit-report.json || true
          if [ -f bandit-report.json ]; then
            python -m json.tool bandit-report.json
          fi

  function-implementation-check:
    name: "ğŸ”¨ Verify Functions Are Implemented"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Check for empty functions"
        run: |
          echo "Checking for empty functions with only 'pass'..."

          # Find functions that only contain pass
          FOUND_EMPTY=0
          for file in $(find pkg/hanzo-mcp -name "*.py" -not -path "*/test*"); do
            # Look for functions with only pass
            if grep -Pzo "def\s+\w+\([^)]*\):\s*\n\s*pass\s*$" "$file" 2>/dev/null; then
              echo "âŒ Empty function found in: $file"
              FOUND_EMPTY=1
            fi

            # Look for functions with only ellipsis
            if grep -Pzo "def\s+\w+\([^)]*\):\s*\n\s*\.\.\.\s*$" "$file" 2>/dev/null; then
              echo "âŒ Ellipsis-only function found in: $file"
              FOUND_EMPTY=1
            fi
          done

          if [ $FOUND_EMPTY -eq 1 ]; then
            echo "ğŸš« BLOCKED: Empty functions detected! Implement them properly!"
            exit 1
          fi

          echo "âœ… All functions have implementations"

  block-deployment:
    name: "ğŸš€ Deployment Gate"
    needs:
      - block-todo-stub-code
      - test-no-stubs
      - all-tests-must-pass
      - code-quality
      - function-implementation-check
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.ref == 'refs/heads/main'

    steps:
      - name: "âœ… Quality Gate PASSED"
        run: |
          echo "âœ… All quality checks passed!"
          echo "âœ… No TODOs, STUBs, or FAKE code found"
          echo "âœ… All tests are passing"
          echo "âœ… All functions are implemented"
          echo "ğŸš€ Ready for deployment!"

      - name: "ğŸ“¦ Prepare for PyPI deployment"
        if: github.event_name == 'release'
        run: |
          echo "Ready to deploy to PyPI"
          echo "Version: ${{ github.event.release.tag_name }}"

  publish-to-pypi:
    name: "ğŸ“¦ Publish to PyPI"
    needs: [block-deployment]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build package
        run: |
          pip install uv
          cd pkg/hanzo-mcp
          uv build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          pip install twine
          cd pkg/hanzo-mcp
          twine upload dist/* --non-interactive --skip-existing